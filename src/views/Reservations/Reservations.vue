<template>
	<div class="container" id="reservations">
		<section class="padding-of-section mt-5 py-3 py-sm-5">
			<div class="row mb-0 mb-sm-5">
				<div class="col-xs-12">
					<content-title :contentTitle="$t('pages.reservations.pageTitle')"></content-title>
					<content-paragraph></content-paragraph>
				</div>
			</div>
		</section>
		<div class="overlay-wrapper my-5" v-if="!optionSelected">
			<div class="overlay-options">
				<div class="picker-input">
					<HotelDatePicker class="custom-picker"
					                 :checkIn="orderDetails.checkIn"
					                 :checkOut="orderDetails.checkOut"
					                 :startDate="new Date()"
					                 :i18n="defineDatePicker()"
					                 v-on:checkInChanged="orderDetails.checkIn = $event"
					                 v-on:checkOutChanged="orderDetails.checkOut = $event">
					</HotelDatePicker>
					<h5 class="error-message" v-if="errorDate"><span class="ti-alert"></span>{{ $t('error.checkInOut') }}
					</h5>
					<div class="no-of-people">
						<span class="people-title">{{$t('components.booking.bookingSticky.adultTitle')}}</span>
						<span class="controls">
						<button type="button" @click="changePeopleNumber('minus', 0)" class="btn btn-minus"
						        :disabled="!orderDetails.adults"><span
										class="ti-minus"></span></button>
						<span class="counter-num">{{ orderDetails.adults }}</span>
						<button type="button" @click="changePeopleNumber('add', 0)" class="btn btn-plus"><span
										class="ti-plus"></span></button>
						</span>
					</div>
					
					<div class="no-of-people">
						<span class="people-title">{{$t('components.booking.bookingSticky.childrenTitle')}}</span>
						<span class="controls">
						<button type="button" @click="changePeopleNumber('minus', 1)" class="btn btn-minus"
						        :disabled="!orderDetails.children"><span
										class="ti-minus"></span></button>
						<span class="counter-num">{{ orderDetails.children }}</span>
						<button type="button" @click="changePeopleNumber('add', 1)" class="btn btn-plus"><span
										class="ti-plus"></span></button>
						</span>
					</div>
					<h5 class="error-message" v-if="errorPeople"><span class="ti-alert"></span>
						{{ $t('error.noOfGuest') }}</h5>
				
				</div>
				<button type="button" class="btn btn-main" @click="checkSelected">{{$t('button.submit')}}</button>
			</div>
		</div>
		
		<section class="pb-5" v-if="optionSelected">
			<div class="row py-5">
				<div class="col-md-8 col-xs-12">
					<div class="picker-input">
						<HotelDatePicker
										:startDate="new Date()"
										:i18n="defineDatePicker()"
										v-on:checkInChanged="orderDetails.checkIn = $event"
										v-on:checkOutChanged="checkOutDate($event)"></HotelDatePicker>
						
						<div class="no-of-people">
							<span class="people-title">{{$t('components.booking.bookingSticky.adultTitle')}}</span>
							<span class="controls">
						<button type="button" @click="changePeopleNumber('minus', 0)" class="btn btn-minus"
						        :disabled="!orderDetails.adults"><span
										class="ti-minus"></span></button>
						<span class="counter-num">{{ orderDetails.adults }}</span>
						<button type="button" @click="changePeopleNumber('add', 0)" class="btn btn-plus"><span
										class="ti-plus"></span></button>
						</span>
						</div>
						
						<div class="no-of-people">
							<span class="people-title">{{$t('components.booking.bookingSticky.childrenTitle')}}</span>
							<span class="controls">
						<button type="button" @click="changePeopleNumber('minus', 1)" class="btn btn-minus"
						        :disabled="!orderDetails.children"><span
										class="ti-minus"></span></button>
						<span class="counter-num">{{ orderDetails.children }}</span>
						<button type="button" @click="changePeopleNumber('add', 1)" class="btn btn-plus"><span
										class="ti-plus"></span></button>
						</span>
						</div>
						
						<h5 class="error-message" v-if="errorTotalGuest"><span class="ti-alert"></span>
							{{ $t('error.noOfGuest') }}</h5>
					
					</div>
					<div v-for="(item, index) in roomTypes">
						<room-card :result="item" :index="index" :availableRooms="rooms[item.id]"
						           v-on:roomUpdates="roomDataUpdate"></room-card>
					</div>
				</div>
				<div class="col-md-4 col-xs-12">
					<booking-sticky
									:isMobile="isMobile"
									:orderDetails="orderDetails"
					></booking-sticky>
				</div>
			</div>
		</section>
	</div>
</template>

<script>
  import ContentTitle from '@/components/content/ContentTitle.vue'
  import ContentParagraph from '@/components/content/ContentParagraph.vue'
  import RoomCard from '@/components/booking/RoomCard.vue'
  import BookingSticky from '@/components/booking/BookingSticky.vue'
  import HotelDatePicker from 'vue-hotel-datepicker'

  export default {
    components: {
      BookingSticky,
      RoomCard,
      ContentTitle,
      ContentParagraph,
      HotelDatePicker
    },
    name: 'Reservations',
    data () {
      return {
        bgImageSrc: '/static/img/demo-about-02.jpg',
        optionSelected: false,
        errorDate: false,
        errorPeople: false,
        roomTypes: [],
        rooms: [],
        errorTotalGuest: false,
        orderDetails: {
          checkIn: '',
          checkOut: '',
          adults: 0,
          children: 0,
          totalPrice: 0,
          totalRooms: 0,
          roomObjects: []
        }
      }
    },
    props: {
      isMobile: this.isMobile
    },
    methods: {
      checkSelected: function () {
        // use to check the first step of input in reservation page
        // check the check in out date first
        if (this.orderDetails.checkIn !== '' && this.orderDetails.checkOut !== '') {
          // check how many guest are there
          if (this.orderDetails.adults > 0 || this.orderDetails.children > 0) {
            this.orderDetails.checkIn = this.$moment(this.orderDetails.checkIn).format('YYYY-MM-DD')
            this.orderDetails.checkOut = this.$moment(this.orderDetails.checkOut).format('YYYY-MM-DD')
            this.optionSelected = true
            this.getAvailableRooms()
          } else {
            this.errorPeople = true
          }
        } else {
          this.errorDate = true
        }
      },
      fetchRooms: function () {
        this.axios.get('/api/room-type').then((response) => {
          this.roomTypes = response.data
        }, (error) => {
          console.log(error)
        })
      },
      roomDataUpdate: function (val) {
        this.orderDetails.roomObjects[val.index] = val.room
        this.orderDetails.roomObjects = _.merge(this.orderDetails.roomObjects, this.roomTypes)
        // variable for calculating the total price
        let calPrice = 0
        let roomPrice = _.map(this.orderDetails.roomObjects, 'price')

        // variable for calculating the total rooms
        let calculated = 0
        let result = _.map(this.orderDetails.roomObjects, 'noOfRoom')

        // calculating total rooms and price
        _.forEach(result, function (value, key) {
          if (typeof value !== 'undefined') {
            calculated += value
            calPrice += (roomPrice[key] * value)
          }
        })
        this.orderDetails.totalRooms = calculated
        this.orderDetails.totalPrice = calPrice
      },
      defineDatePicker: function () {
        if (this.orderDetails.checkIn.length !== 0) {
          let datepickerI18n = this.$i18n.getLocaleMessage(this.$i18n.locale).datePicker
          datepickerI18n['check-in'] = this.orderDetails.checkIn
          datepickerI18n['check-out'] = this.orderDetails.checkOut
          return datepickerI18n
        }
        return this.$i18n.getLocaleMessage(this.$i18n.locale).datePicker
      },
      getAvailableRooms: function () {
        this.axios.post('/api/checkAvailableRooms', {
          checkIn: this.orderDetails.checkIn,
          checkOut: this.orderDetails.checkOut
        }).then((response) => {
          this.rooms = response.data
        }, (error) => {
          console.log(error)
        })
      },
      checkOutDate: function (date) {
        this.orderDetails.checkIn = this.$moment(this.orderDetails.checkIn).format('YYYY-MM-DD')
        this.orderDetails.checkOut = this.$moment(date).format('YYYY-MM-DD')
        this.getAvailableRooms()
      },
      changePeopleNumber (type, people) {
        if (type === 'minus') {
          people ? this.orderDetails.children-- : this.orderDetails.adults--
          if (!(this.orderDetails.adults + this.orderDetails.children)) {
            this.errorTotalGuest = true
            people ? this.orderDetails.children += 1 : this.orderDetails.adults += 1
          }
        } else if (type === 'add') {
          people ? this.orderDetails.children++ : this.orderDetails.adults++
          this.errorTotalGuest = false
        }
      }
    },
    mounted: function () {
      this.fetchRooms()
      let defaultOrderDetails = JSON.stringify({
        checkIn: '',
        checkOut: '',
        adults: 0,
        children: 0,
        totalPrice: 0,
        totalRooms: 0,
        roomObjects: []
      })
      this.orderDetails = JSON.parse(this.$localStorage.get('orderDetails', defaultOrderDetails))

      if (this.orderDetails.checkIn.length > 0) {
        this.optionSelected = true
        this.checkSelected()
      }
    },
    watch: {}
  }
</script>

<style lang="scss" scoped>
	@import '../../assets/style/setting';
	
	.overlay-wrapper {
		position: relative;
		display: flex;
		justify-content: center;
		background-color: white;
		min-height: 30vh;
		.overlay-options {
			flex: 0 1 auto;
			align-self: center;
			display: inline-block;
			padding: 2.5rem;
			@media screen and (max-width: 767px) {
				padding: 0;
			}
			.btn-main {
				padding: 0.75rem 3rem;
				border: 1px solid #ECBE03;
				text-transform: uppercase;
				font-weight: bold;
				@media screen and (max-width: 767px) {
					width: 100%;
				}
			}
		}
	}
	
	.picker-input {
		margin: 0 0 2rem;
		padding-bottom: 0;
		& > div {
			height: 40px;
			margin-bottom: 1rem;
			&:last-of-type {
				margin-bottom: 0;
			}
			&.no-of-people {
				display: inline-block;
				min-height: 27px;
				width: calc(50% - 0.75rem);
				padding: 0.5rem 1.5rem;
				border: 1px solid $light-grey;
				border-radius: 5px;
				color: $brand-secondary;
				background-color: white;
				@media screen and (max-width: 767px) {
					width: 100%;
					margin-top: -0.5rem;
				}
				&:last-of-type {
					margin: 0 0 0 1rem;
					@media screen and (max-width: 767px) {
						margin: 0;
					}
				}
				.people-title {
					line-height: 27px;
					margin-right: 0.5rem;
				}
				.controls {
					.btn-minus, .btn-plus {
						background-color: transparent;
						color: $brand-primary;
						width: 25px;
						height: 25px;
						border: 1px solid $brand-primary;
						border-radius: 50%;
						padding: 0;
						line-height: 25px;
						font-size: 15px;
						vertical-align: middle;
						outline: none;
					}
				}
			}
		}
	}

</style>
<style lang="scss">
	@import '../../assets/style/setting';
	
	.picker-input {
		margin: 0 0 1rem;
		padding-bottom: 2rem;
		.datepicker__wrapper {
			height: 40px;
			background-color: transparent;
			background-image: url('../../assets/img/calendar-brand-sec.svg');
			.datepicker__dummy-wrapper {
				border-color: $light-grey;
				border-radius: 5px;
				.datepicker__dummy-input {
					height: 40px;
					color: $brand-secondary;
					cursor: pointer;
					&::placeholder {
						color: $brand-secondary;
					}
					&:first-child {
						background-image: url('../../assets/img/arrow-brand-sec.svg')
					}
				}
			}
			&.custom-picker {
				border-radius: 5px;
				border: 1px solid $light-grey;
				background-color: white;
				.datepicker__dummy-wrapper {
					border: none;
					border-radius: 0;
				}
			}
			.datepicker__clear-button {
				color: $brand-secondary;
				margin: 0 -2px 0 0;
				
			}
		}
	}
	
	.datepicker {
		top: 40px;
	}
	
	.datepicker__month-day {
		cursor: pointer;
	}

</style>
